import { createPublicClient, createWalletClient, http, parseAbi } from "viem";
import { mainnet, optimism } from "viem/chains";
import { privateKeyToAccount } from "viem/accounts";

const account = privateKeyToAccount(
  "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80",
);

const walletClient = createWalletClient({
  account,
  chain: optimism,
  transport: http(
    "https://virtual.rpc.tenderly.co/godofdeath/project/private/base/da9775f9-38c5-45f4-a930-d88b02729bfd",
  ),
});

// const publicClient = createPublicClient({
//   chain: mainnet,
//   transport: http(
//     "https://virtual.rpc.tenderly.co/godofdeath/project/private/etherum-fork1/e0771959-4d8b-4382-9b62-c26eb29cd765"
//   ),
// });
const publicOpClient = createPublicClient({
  chain: optimism,
  transport: http(
    "https://virtual.rpc.tenderly.co/godofdeath/project/private/base/da9775f9-38c5-45f4-a930-d88b02729bfd",
  ),
});

const RESCUE_EXECUTOR_ABI = parseAbi([
  // =========================
  // Constructor
  // =========================
  "constructor(address _keeper, address _lifiRouter, uint256 _cooldownSeconds)",

  // =========================
  // Errors
  // =========================
  "error OnlyKeeper()",
  "error CooldownActive(uint256 remaining)",
  "error InvalidTarget()",
  "error ERC20TransferFailed()",
  "error ERC20ApproveFailed()",
  "error LiFiCallFailed()",
  "error ResidualBalance()",

  // =========================
  // Events
  // =========================
  "event RescueExecuted(address indexed user, address indexed tokenIn, uint256 amountIn, uint256 timestamp)",

  // =========================
  // View / Public Variables
  // =========================
  "function keeper() view returns (address)",
  "function lifiRouter() view returns (address)",
  "function COOLDOWN_SECONDS() view returns (uint256)",
  "function lastRescueAt(address user) view returns (uint256)",

  // =========================
  // Core Function
  // =========================
  "function executeRescue(address user, address tokenIn, uint256 amountIn, bytes callData) external payable",

  // =========================
  // Receive ETH
  // =========================
  "receive() external payable",
]);

// // // Deploy contract
// const hash = await walletClient.deployContract({
//   abi: RESCUE_EXECUTOR_ABI,
//   bytecode: "0x60e060405234801561000f575f5ffd5b50604051610eb9380380610eb98339818101604052810190610031919061013a565b8273ffffffffffffffffffffffffffffffffffffffff1660808173ffffffffffffffffffffffffffffffffffffffff16815250508173ffffffffffffffffffffffffffffffffffffffff1660a08173ffffffffffffffffffffffffffffffffffffffff16815250508060c0818152505050505061018a565b5f5ffd5b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6100d6826100ad565b9050919050565b6100e6816100cc565b81146100f0575f5ffd5b50565b5f81519050610101816100dd565b92915050565b5f819050919050565b61011981610107565b8114610123575f5ffd5b50565b5f8151905061013481610110565b92915050565b5f5f5f60608486031215610151576101506100a9565b5b5f61015e868287016100f3565b935050602061016f868287016100f3565b925050604061018086828701610126565b9150509250925092565b60805160a05160c051610ce96101d05f395f818161021a0152818161024e01526107f201525f818161013001526102c101525f818161015401526108160152610ce95ff3fe60806040526004361061004d575f3560e01c8063336c6e64146100585780635e010e841461008257806372b49d631461009e578063aced1661146100c8578063f4f4e6c0146100f257610054565b3661005457005b5f5ffd5b348015610063575f5ffd5b5061006c61012e565b604051610079919061088b565b60405180910390f35b61009c6004803603810190610097919061096a565b610152565b005b3480156100a9575f5ffd5b506100b26107f0565b6040516100bf91906109fd565b60405180910390f35b3480156100d3575f5ffd5b506100dc610814565b6040516100e9919061088b565b60405180910390f35b3480156100fd575f5ffd5b5061011860048036038101906101139190610a16565b610838565b60405161012591906109fd565b60405180910390f35b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000073ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16146101d7576040517fc60eb33500000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b845f5f5f8373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f205490507f0000000000000000000000000000000000000000000000000000000000000000816102449190610a6e565b4210156102be57427f0000000000000000000000000000000000000000000000000000000000000000826102789190610a6e565b6102829190610aa1565b6040517fc1ab61a10000000000000000000000000000000000000000000000000000000081526004016102b591906109fd565b60405180910390fd5b5f7f00000000000000000000000000000000000000000000000000000000000000009050425f5f8a73ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020019081526020015f20819055505f73ffffffffffffffffffffffffffffffffffffffff168773ffffffffffffffffffffffffffffffffffffffff161461057b575f8773ffffffffffffffffffffffffffffffffffffffff166323b872dd8a308a6040518463ffffffff1660e01b815260040161039493929190610ad4565b6020604051808303815f875af11580156103b0573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906103d49190610b3e565b90508061040d576040517ff27f64e400000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8873ffffffffffffffffffffffffffffffffffffffff1663095ea7b3845f6040518363ffffffff1660e01b8152600401610449929190610bab565b6020604051808303815f875af1158015610465573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906104899190610b3e565b9050806104c2576040517f378dc23b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f8973ffffffffffffffffffffffffffffffffffffffff1663095ea7b3858b6040518363ffffffff1660e01b81526004016104fe929190610bd2565b6020604051808303815f875af115801561051a573d5f5f3e3d5ffd5b505050506040513d601f19601f8201168201806040525081019061053e9190610b3e565b905080610577576040517f378dc23b00000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5050505b5f8173ffffffffffffffffffffffffffffffffffffffff163487876040516105a4929190610c35565b5f6040518083038185875af1925050503d805f81146105de576040519150601f19603f3d011682016040523d82523d5f602084013e6105e3565b606091505b505090508061061e576040517f82d089a700000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5f73ffffffffffffffffffffffffffffffffffffffff168873ffffffffffffffffffffffffffffffffffffffff161461077e578773ffffffffffffffffffffffffffffffffffffffff1663095ea7b3835f6040518363ffffffff1660e01b815260040161068c929190610bab565b6020604051808303815f875af11580156106a8573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906106cc9190610b3e565b505f8873ffffffffffffffffffffffffffffffffffffffff166370a08231306040518263ffffffff1660e01b8152600401610707919061088b565b602060405180830381865afa158015610722573d5f5f3e3d5ffd5b505050506040513d601f19601f820116820180604052508101906107469190610c61565b1461077d576040517f850fd1b000000000000000000000000000000000000000000000000000000000815260040160405180910390fd5b5b8773ffffffffffffffffffffffffffffffffffffffff168973ffffffffffffffffffffffffffffffffffffffff167f53fd376d9a8b26148de4fa3711c48fea6dcf06b080ece04c946a8129ece8ef9c89426040516107dd929190610c8c565b60405180910390a3505050505050505050565b7f000000000000000000000000000000000000000000000000000000000000000081565b7f000000000000000000000000000000000000000000000000000000000000000081565b5f602052805f5260405f205f915090505481565b5f73ffffffffffffffffffffffffffffffffffffffff82169050919050565b5f6108758261084c565b9050919050565b6108858161086b565b82525050565b5f60208201905061089e5f83018461087c565b92915050565b5f5ffd5b5f5ffd5b6108b58161086b565b81146108bf575f5ffd5b50565b5f813590506108d0816108ac565b92915050565b5f819050919050565b6108e8816108d6565b81146108f2575f5ffd5b50565b5f81359050610903816108df565b92915050565b5f5ffd5b5f5ffd5b5f5ffd5b5f5f83601f84011261092a57610929610909565b5b8235905067ffffffffffffffff8111156109475761094661090d565b5b60208301915083600182028301111561096357610962610911565b5b9250929050565b5f5f5f5f5f60808688031215610983576109826108a4565b5b5f610990888289016108c2565b95505060206109a1888289016108c2565b94505060406109b2888289016108f5565b935050606086013567ffffffffffffffff8111156109d3576109d26108a8565b5b6109df88828901610915565b92509250509295509295909350565b6109f7816108d6565b82525050565b5f602082019050610a105f8301846109ee565b92915050565b5f60208284031215610a2b57610a2a6108a4565b5b5f610a38848285016108c2565b91505092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f610a78826108d6565b9150610a83836108d6565b9250828201905080821115610a9b57610a9a610a41565b5b92915050565b5f610aab826108d6565b9150610ab6836108d6565b9250828203905081811115610ace57610acd610a41565b5b92915050565b5f606082019050610ae75f83018661087c565b610af4602083018561087c565b610b0160408301846109ee565b949350505050565b5f8115159050919050565b610b1d81610b09565b8114610b27575f5ffd5b50565b5f81519050610b3881610b14565b92915050565b5f60208284031215610b5357610b526108a4565b5b5f610b6084828501610b2a565b91505092915050565b5f819050919050565b5f819050919050565b5f610b95610b90610b8b84610b69565b610b72565b6108d6565b9050919050565b610ba581610b7b565b82525050565b5f604082019050610bbe5f83018561087c565b610bcb6020830184610b9c565b9392505050565b5f604082019050610be55f83018561087c565b610bf260208301846109ee565b9392505050565b5f81905092915050565b828183375f83830152505050565b5f610c1c8385610bf9565b9350610c29838584610c03565b82840190509392505050565b5f610c41828486610c11565b91508190509392505050565b5f81519050610c5b816108df565b92915050565b5f60208284031215610c7657610c756108a4565b5b5f610c8384828501610c4d565b91505092915050565b5f604082019050610c9f5f8301856109ee565b610cac60208301846109ee565b939250505056fea2646970667358221220d45f5ee236316894a4e4ab0854efaf3e5f63cea0a59f51ca71915d310acdf97d64736f6c63430008210033",
//   args: ["0xf39Fd6e51aad88F6F4ce6aB8827279cffFb92266",'0x1231DEB6f5749EF6cE6943a275A1D3E7486F4EaE',BigInt(120)], // Constructor arguments
// });

// console.log("Deployment tx:", hash);

// // Wait for deployment
// const receipt = await publicOpClient.waitForTransactionReceipt({ hash });
// console.log("Contract deployed at:", receipt.contractAddress);

// ================================================================
const aaveUserDataAbi = [
  {
    inputs: [
      {
        internalType: "address",
        name: "user",
        type: "address",
      },
    ],
    name: "getUserAccountData",
    outputs: [
      {
        internalType: "uint256",
        name: "totalCollateralBase",
        type: "uint256",
      },
      {
        internalType: "uint256",
        name: "totalDebtBase",
        type: "uint256",
      },
      {
        internalType: "uint256",
        name: "availableBorrowsBase",
        type: "uint256",
      },
      {
        internalType: "uint256",
        name: "currentLiquidationThreshold",
        type: "uint256",
      },
      {
        internalType: "uint256",
        name: "ltv",
        type: "uint256",
      },
      {
        internalType: "uint256",
        name: "healthFactor",
        type: "uint256",
      },
    ],
    stateMutability: "view",
    type: "function",
  },
];

// const AAVE_USER = "0xb789576d412aeec021fe01ded9541b272f472aab"  // who borrowed loan form aave
const AAVE_USER = "0xcaf4bfb53e07fd02e7e46894564d7caac3d9b35b"  

const data = await publicOpClient.readContract({
  abi: aaveUserDataAbi,
  address: "0x794a61358D6845594F94dc1DB02A252b5b4814aD", // pool contract address
  functionName: "getUserAccountData",
  args: [ AAVE_USER ], // addr of borrower (user)
});
console.log(data);
const [
  totalCollateralBase,
  totalDebtBase,
  availableBorrowsBase,
  currentLiquidationThreshold,
  ltv,
  healthFactor,
] = data as [bigint, bigint, bigint, bigint, bigint, bigint];

const ONE = 10n ** 18n;

console.log("===== Aave User Account Data (OP Mainnet) =====");
console.log("Total Collateral (base):", totalCollateralBase.toString());
console.log("Total Debt (base):", totalDebtBase.toString());
console.log("Available Borrows (base):", availableBorrowsBase.toString());
console.log(
  "Liquidation Threshold (%):",
  Number(currentLiquidationThreshold) / 100,
);
console.log("LTV (%):", Number(ltv) / 100);
console.log(
  "Health Factor (HF):",
  (Number(healthFactor) / 1e18).toFixed(2),
  healthFactor < ONE ? "❌ LIQUIDATABLE" : "✅ SAFE",
);
console.log("=============================================");
